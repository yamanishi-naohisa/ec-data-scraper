# 通販事業所データ取得システム 詳細仕様書

## 1. プロジェクト概要

### 1.1 目的
通販（EC）事業に関連する事業所の情報をWebから自動的に収集し、構造化されたデータとして保存・管理するPythonプログラムを開発する。

### 1.2 対象範囲
- 通販事業を営む事業所の基本情報を収集
- データの取得、整形、保存、更新機能を提供
- 将来的な拡張性を考慮した設計

### 1.3 期待される成果物
- 通販事業所データを取得するPythonスクリプト
- データベース（SQLite）に保存された構造化データ
- 取得データのCSV/Excelエクスポート機能

## 2. データソース

### 2.1 想定データソース（候補）
以下のいずれか、または複数のデータソースから取得を検討：

1. **公的データソース**
   - 経済産業省の商業統計調査データ
   - 総務省統計局の事業所・企業統計調査
   - 各都道府県の商業施設データ

2. **業界団体・協会のデータ**
   - 日本通信販売協会（JADMA）の会員リスト
   - 各ECプラットフォームの事業者リスト

3. **Webサイトからのスクレイピング**
   - 通販事業者一覧サイト
   - 業界情報サイト
   - 企業情報データベースサイト

4. **API提供サービス**
   - 企業情報API（有料サービス含む）
   - オープンデータAPI

### 2.2 データソース選定基準
- データの正確性と信頼性
- 定期的な更新頻度
- 利用規約・法的制約の確認
- データ取得の技術的実現可能性

## 3. 取得データ項目

### 3.1 必須データ項目
| 項目名 | データ型 | 説明 | 例 |
|--------|----------|------|-----|
| 事業所名 | String | 事業所の正式名称 | 株式会社○○通販 |
| 所在地 | String | 事業所の住所 | 東京都○○区○○1-2-3 |
| 郵便番号 | String | 郵便番号 | 123-4567 |
| 電話番号 | String | 代表電話番号 | 03-1234-5678 |
| ウェブサイトURL | String | 事業所のWebサイトURL | https://example.com |
| 取得日時 | DateTime | データ取得日時 | 2024-01-01 12:00:00 |

### 3.2 任意データ項目
| 項目名 | データ型 | 説明 | 例 |
|--------|----------|------|-----|
| 事業者番号 | String | 法人番号や事業者識別番号 | 1234567890123 |
| 代表者名 | String | 代表者氏名 | 山田 太郎 |
| 設立年月日 | Date | 事業所の設立日 | 2020-04-01 |
| 従業員数 | Integer | 従業員数 | 50 |
| 取扱商品カテゴリ | String | 主要取扱商品カテゴリ | 衣料品、雑貨 |
| 売上高 | Integer | 年間売上高（万円） | 10000 |
| メールアドレス | String | 問い合わせメールアドレス | info@example.com |
| 備考 | String | その他の情報 | - |

## 4. システム要件

### 4.1 動作環境
- **OS**: Windows 10以上、Linux、macOS
- **Python**: 3.8以上（推奨: 3.10以上）
- **メモリ**: 4GB以上（推奨: 8GB以上）
- **ストレージ**: 500MB以上の空き容量

### 4.2 必要なライブラリ
```
requests>=2.31.0          # HTTPリクエスト
beautifulsoup4>=4.12.0    # HTML解析
pandas>=2.0.0             # データ処理
sqlalchemy>=2.0.0         # データベース操作
openpyxl>=3.1.0           # Excel出力
lxml>=4.9.0               # XML/HTML解析
selenium>=4.15.0          # 動的コンテンツ取得（必要に応じて）
python-dotenv>=1.0.0      # 環境変数管理
```

## 5. 機能要件

### 5.1 データ取得機能
- **機能ID**: F001
- **説明**: Webから通販事業所データを取得する
- **入力**: データソースURL、取得条件
- **出力**: 取得した生データ
- **処理内容**:
  1. 指定されたURLにHTTPリクエストを送信
  2. HTMLコンテンツを取得
  3. HTMLを解析して必要な情報を抽出
  4. データを構造化

### 5.2 データ整形機能
- **機能ID**: F002
- **説明**: 取得したデータを整形・正規化する
- **入力**: 生データ
- **出力**: 整形済みデータ
- **処理内容**:
  1. データのクリーニング（空白除去、改行除去など）
  2. データ形式の統一（電話番号、郵便番号のフォーマット統一）
  3. 重複データの検出
  4. 必須項目の検証

### 5.3 データ保存機能
- **機能ID**: F003
- **説明**: 整形したデータをデータベースに保存する
- **入力**: 整形済みデータ
- **出力**: データベースレコード
- **処理内容**:
  1. データベース接続
  2. テーブル存在確認（存在しない場合は作成）
  3. データの挿入または更新
  4. トランザクション管理

### 5.4 データ検索機能
- **機能ID**: F004
- **説明**: 保存されたデータを検索・抽出する
- **入力**: 検索条件（事業所名、所在地など）
- **出力**: 検索結果データ
- **処理内容**:
  1. 検索条件の解析
  2. SQLクエリの生成
  3. データベースから検索実行
  4. 結果の返却

### 5.5 データエクスポート機能
- **機能ID**: F005
- **説明**: データをCSV/Excel形式でエクスポートする
- **入力**: エクスポート条件、ファイル形式
- **出力**: CSV/Excelファイル
- **処理内容**:
  1. データベースからデータ取得
  2. pandas DataFrameに変換
  3. CSV/Excel形式でファイル出力

### 5.6 ログ機能
- **機能ID**: F006
- **説明**: 処理状況やエラー情報をログに記録する
- **入力**: ログメッセージ、ログレベル
- **出力**: ログファイル
- **処理内容**:
  1. ログレベルの設定（INFO, WARNING, ERROR）
  2. ログファイルへの記録
  3. コンソールへの出力（オプション）

### 5.7 エラーハンドリング機能
- **機能ID**: F007
- **説明**: エラー発生時の適切な処理を行う
- **入力**: エラー情報
- **出力**: エラーログ、エラーメッセージ
- **処理内容**:
  1. ネットワークエラーの検出とリトライ
  2. データ取得失敗時のスキップ処理
  3. データベースエラーの処理
  4. エラーログの記録

## 6. 技術仕様

### 6.1 アーキテクチャ
```
┌─────────────────┐
│  メインスクリプト  │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
┌───▼───┐ ┌──▼────┐
│データ取得│ │データ整形│
│ モジュール │ │ モジュール │
└───┬───┘ └──┬────┘
    │         │
    └────┬────┘
         │
    ┌────▼────┐
    │データ保存│
    │ モジュール │
    └────┬────┘
         │
    ┌────▼────┐
    │データベース│
    └─────────┘
```

### 6.2 データベース設計

#### 6.2.1 テーブル定義: `ec_companies`
| カラム名 | データ型 | 制約 | 説明 |
|----------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主キー |
| company_name | TEXT | NOT NULL | 事業所名 |
| address | TEXT | | 所在地 |
| postal_code | TEXT | | 郵便番号 |
| phone_number | TEXT | | 電話番号 |
| website_url | TEXT | | ウェブサイトURL |
| company_number | TEXT | | 事業者番号 |
| representative | TEXT | | 代表者名 |
| established_date | DATE | | 設立年月日 |
| employee_count | INTEGER | | 従業員数 |
| product_categories | TEXT | | 取扱商品カテゴリ |
| annual_sales | INTEGER | | 売上高（万円） |
| email | TEXT | | メールアドレス |
| notes | TEXT | | 備考 |
| created_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| updated_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | 更新日時 |
| source_url | TEXT | | データ取得元URL |

#### 6.2.2 インデックス
- `company_name`: 事業所名での検索高速化
- `postal_code`: 郵便番号での検索高速化
- `website_url`: URLでの重複チェック高速化

### 6.3 ファイル構成
```
通販データ取得/
├── main.py                 # メインスクリプト
├── config.py               # 設定ファイル
├── scraper.py              # データ取得モジュール
├── data_processor.py       # データ整形モジュール
├── database.py             # データベース操作モジュール
├── exporter.py             # データエクスポートモジュール
├── utils.py                # ユーティリティ関数
├── requirements.txt        # 依存パッケージ一覧
├── .env.example            # 環境変数テンプレート
├── README.md               # プロジェクト説明書
├── 詳細仕様書.md            # 本仕様書
├── logs/                   # ログファイル保存ディレクトリ
│   └── app.log
├── data/                   # データ保存ディレクトリ
│   ├── ec_companies.db     # SQLiteデータベース
│   └── exports/            # エクスポートファイル保存先
└── tests/                  # テストコード
    ├── test_scraper.py
    ├── test_data_processor.py
    └── test_database.py
```

## 7. 実装手順

### 7.1 フェーズ1: 環境構築
1. Python仮想環境の作成
2. 必要なライブラリのインストール
3. プロジェクトディレクトリ構造の作成
4. 設定ファイルの作成

### 7.2 フェーズ2: データベース実装
1. データベーススキーマの定義
2. データベース接続モジュールの実装
3. CRUD操作の実装
4. トランザクション管理の実装

### 7.3 フェーズ3: データ取得実装
1. HTTPリクエスト処理の実装
2. HTML解析処理の実装
3. データ抽出ロジックの実装
4. エラーハンドリングの実装

### 7.4 フェーズ4: データ処理実装
1. データクリーニング機能の実装
2. データ正規化機能の実装
3. 重複チェック機能の実装
4. データ検証機能の実装

### 7.5 フェーズ5: エクスポート機能実装
1. CSV出力機能の実装
2. Excel出力機能の実装
3. データフィルタリング機能の実装

### 7.6 フェーズ6: 統合・テスト
1. 各モジュールの統合
2. エンドツーエンドテスト
3. エラーハンドリングのテスト
4. パフォーマンステスト

## 8. 非機能要件

### 8.1 パフォーマンス
- データ取得処理: 1件あたり3秒以内
- データベースクエリ: 1000件の検索を5秒以内
- メモリ使用量: 500MB以内

### 8.2 信頼性
- ネットワークエラー時の自動リトライ（最大3回）
- データ取得失敗時のスキップ処理
- トランザクション管理によるデータ整合性の保証

### 8.3 保守性
- モジュール化された設計
- コメントとdocstringの充実
- ログ出力による処理状況の可視化

### 8.4 セキュリティ
- 環境変数による機密情報の管理
- SQLインジェクション対策（パラメータ化クエリ）
- ユーザーエージェントの設定による適切なリクエスト

## 9. 注意事項・制約事項

### 9.1 法的遵守
- **robots.txtの遵守**: 対象サイトの`robots.txt`を確認し、スクレイピングが許可されているかを確認する
- **利用規約の確認**: 対象サイトの利用規約を確認し、データ取得が許可されているかを確認する
- **個人情報保護**: 個人情報が含まれる可能性があるデータの取り扱いに注意する
- **著作権**: 取得したデータの利用目的が著作権法に違反しないことを確認する

### 9.2 技術的制約
- **レート制限**: サーバーへの負荷を考慮し、リクエスト間隔を適切に設定する（推奨: 1秒以上）
- **タイムアウト**: ネットワークリクエストにタイムアウトを設定する（推奨: 30秒）
- **動的コンテンツ**: JavaScriptで動的に生成されるコンテンツの場合はSelenium等の使用を検討する

### 9.3 データの正確性
- 取得したデータの正確性を保証するものではない
- 定期的なデータの更新と検証が必要
- データ取得元の情報が変更された場合、取得データも古くなる可能性がある

## 10. 今後の拡張性

### 10.1 機能拡張の候補
- 複数データソースからの取得対応
- データ更新の自動検知と差分更新
- Web API化（REST API）
- ダッシュボード機能（データ可視化）
- データ分析機能（統計情報の算出）

### 10.2 技術的拡張の候補
- 非同期処理による高速化（asyncio）
- 分散処理による大規模データ取得対応
- クラウドストレージへのデータ保存
- 機械学習によるデータ品質向上

## 11. テスト計画

### 11.1 単体テスト
- 各モジュールの機能テスト
- エラーハンドリングのテスト
- データ検証ロジックのテスト

### 11.2 統合テスト
- データ取得から保存までの一連の流れのテスト
- データベース操作のテスト
- エクスポート機能のテスト

### 11.3 パフォーマンステスト
- 大量データ取得時のパフォーマンス測定
- データベースクエリのパフォーマンス測定

## 12. 運用・保守

### 12.1 ログ管理
- ログファイルのローテーション（日次またはサイズベース）
- エラーログの監視とアラート

### 12.2 データ管理
- 定期的なデータバックアップ
- データベースの最適化（VACUUM等）

### 12.3 更新管理
- 依存ライブラリの定期的な更新
- セキュリティパッチの適用

## 13. 参考資料

- Python公式ドキュメント: https://docs.python.org/ja/
- Beautiful Soup ドキュメント: https://www.crummy.com/software/BeautifulSoup/bs4/doc/
- pandas ドキュメント: https://pandas.pydata.org/docs/
- SQLAlchemy ドキュメント: https://www.sqlalchemy.org/

---

**作成日**: 2024年
**バージョン**: 1.0
**作成者**: システム開発チーム

